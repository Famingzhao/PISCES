epi.patients <- metadata$PatientID[ match(colnames(epi.vip), metadata$SampleID) ]
shared.patients <- intersect(stroma.patients, epi.patients)
stroma.meta <- metadata[ which(metadata$Compartment == 'Stroma') ,]
matched.stromaID <- stroma.meta$SampleID[ match(shared.patients, stroma.meta$PatientID) ]
epi.meta <- metadata[ which(metadata$Compartment == 'Epithelium') ,]
matched.epiID <- epi.meta$SampleID[ match(shared.patients, epi.meta$PatientID) ]
length(matched.stromaID)
length(matched.epiID)
matched.stromaID
matched.epiID
View(metadata)
stroma.vip <- stroma.vip[, matched.stromaID]
epi.vip <- epi.vip[, matched.epiID]
colnames(stroma.vip)
stroma.vip <- stroma.vip[, as.character(matched.stromaID) ]
epi.vip <- epi.vip[, as.character(matched.epiID) ]
stroma.mrs <- readRDS('C://Users/lvlah/linux/ac_lab/tumor_geom/lcm_stroma_msViper.rds')
epi.mrs <- readRDS('C://Users/lvlah/linux/ac_lab/tumor_geom/lcm_epi_msViper.rds')
stroma.vip <- readRDS('C://Users/lvlah/linux/ac_lab/tumor_geom/lcm_stroma_viper.rds')
epi.vip <- readRDS('C://Users/lvlah/linux/ac_lab/tumor_geom/lcm_epi_viper.rds')
metadata <- read.table('C://Users/lvlah/linux/ac_lab/data/lcm_pda/PDAC-Interactome-Samples_newOk.txt',
header = TRUE, sep = '\t')
############################
### generate correlation model(s) between stroma and epi compartments in lcm ###
## sync up IDs
stroma.patients <- metadata$PatientID[ match(colnames(stroma.vip), metadata$SampleID) ]
epi.patients <- metadata$PatientID[ match(colnames(epi.vip), metadata$SampleID) ]
shared.patients <- intersect(stroma.patients, epi.patients)
stroma.meta <- metadata[ which(metadata$Compartment == 'Stroma') ,]
matched.stromaID <- stroma.meta$SampleID[ match(shared.patients, stroma.meta$PatientID) ]
epi.meta <- metadata[ which(metadata$Compartment == 'Epithelium') ,]
matched.epiID <- epi.meta$SampleID[ match(shared.patients, epi.meta$PatientID) ]
length(matched.stromaID)
length(matched.epiID)
stroma.vip <- stroma.vip[, as.character(matched.stromaID) ]
epi.vip <- epi.vip[, as.character(matched.epiID) ]
## subset for the top master regulators
stroma.topMRs <- names(sort(stroma.mrs$es$nes, decreasing = TRUE))[1:100]
epi.topMRs <- names(sort(epi.mrs$es$nes, decreasing = TRUE))[1:100]
design.mat <- rbind( stroma.vip[stroma.topMRs, ] , epi.vip[epi.topMRs, ] )
rownames(epi.vip)
epi.topMRs
hugo.names <- readRDS("C://Users/lvlah/linux/ac_lab/Hugo.Names.rds")
rownames(stroma.vip) <- hugo.names[ rownames(stroma.vip) ]
rownames(epi.vip) <- hugo.names[ rownames(epi.vip) ]
design.mat <- rbind( stroma.vip[stroma.topMRs, ] , epi.vip[epi.topMRs, ] )
rownames(stroma.vip)
stroma.topMRs
View(stroma.vip)
rownames(stroma.vip)
length(intersect(stroma.topMRs, rownames(stroma.vip)))
length(intersect(epi.topMRs, rownames(epi.vip)))
design.mat <- rbind( stroma.vip[stroma.topMRs, ] , epi.vip[ intersect(rownames(epi.vip), epi.topMRs) , ] )
dim(design.mat)
design.mat <- t(design.mat)
## fit MMR model
mmr.model <- lm(design.mat[,1:100] ~ design.mat[,101:ncol(design.mat)], data = design.mat)
design.mat <- rbind( stroma.vip[stroma.topMRs, ] , epi.vip[ intersect(rownames(epi.vip), epi.topMRs) , ] )
design.mat <- as.data.frame(t(design.mat))
## fit MMR model
mmr.model <- lm(design.mat[,1:100] ~ design.mat[,101:ncol(design.mat)], data = design.mat)
## fit MMR model
mmr.model <- lm(colnames(design.mat)[1:100] ~ ., data = design.mat)
length(intersect(stroma.topMRs, epi.topMRs))
shared.topMRs <- intersect(stroma.topMRs, epi.topMRs)
stroma.topMRs <- setdiff(stroma.topMRs, shared.topMRs)
epi.topMRs <- setdiff(epi.topMRs, shared.topMRs)
length(stroma.topMRs)
design.mat <- rbind( stroma.vip[stroma.topMRs, ] , epi.vip[ intersect(rownames(epi.vip), epi.topMRs) , ] )
design.mat <- as.data.frame(t(design.mat))
## fit MMR model
mmr.model <- lm(colnames(design.mat)[1:100] ~ ., data = design.mat)
stroma.MRmat <- stroma.vip[ intersect(names(sort(stroma.mrs$es$nes, decreasing = TRUE))[1:100], rownames(stroma.vip)) ,]
rownames(stroma.MRmat) <- paste('S.', rownames(stroma.MRmat), sep = '')
epi.MRmat <- epi.vip[ intersect(names(sort(epi.mrs$es$nes, decreasing = TRUE))[1:100], rownames(epi.vip)) ,]
rownames(epi.MRmat) <- paste('S.', rownames(epi.MRmat), sep = '')
design.mat <- rbind( stroma.MRmat , epi.MRmat )
design.mat <- as.data.frame( t(design.mat) )
stroma.MRmat <- stroma.vip[ intersect(names(sort(stroma.mrs$es$nes, decreasing = TRUE))[1:100], rownames(stroma.vip)) ,]
rownames(stroma.MRmat) <- paste('S.', rownames(stroma.MRmat), sep = '')
epi.MRmat <- epi.vip[ intersect(names(sort(epi.mrs$es$nes, decreasing = TRUE))[1:100], rownames(epi.vip)) ,]
rownames(epi.MRmat) <- paste('E.', rownames(epi.MRmat), sep = '')
design.mat <- rbind( stroma.MRmat , epi.MRmat )
design.mat <- as.data.frame( t(design.mat) )
dim(design.mat)
## fit MMR model
mmr.model <- lm(colnames(design.mat)[1:100] ~ ., data = design.mat)
View(design.mat)
length(is.na(design.mat))
which(is.na(design.mat))
colnames(design.mat)
colnames(design.mat) <- as.name(colnames(design.mat))
colnames(design.mat) <- noquote(colnames(design.mat))
colnames(design.mat)
## fit MMR model
mmr.model <- lm(colnames(design.mat)[1:100] ~ ., data = design.mat)
## fit MMR model
mmr.model <- lm(colnames(design.mat)[1:100] ~ ., data = design.mat)
## fit MMR model
mmr.model <- lm(colnames(design.mat)[1:100] ~ colnames(design.mat)[101:ncol(design.mat)], data = design.mat)
## fit MMR model
ivs <- paste(colnames(design.mat)[101:ncol(design.mat)], sep = ' + ')
ivs
## fit MMR model
ivs <- paste(colnames(design.mat)[101:ncol(design.mat)], collapse = ' + ')
ivs
## fit MMR model
dvs <- paste(colnames(design.mat)[1:100, collapse = ' + ')
## fit MMR model
dvs <- paste(colnames(design.mat)[1:100], collapse = ' + ')
dvs
## fit MMR model
dvs <- paste(colnames(design.mat)[1:100], collapse = ' + ')
ivs <- paste(colnames(design.mat)[101:ncol(design.mat)], collapse = ' + ')
mmr.model <- lm(dvs ~ ivs, data = design.mat)
mmr.model <- lm(colnames(design.mat)[1:100] ~ ivs, data = design.mat)
ivs
mmr.model <- lm(as.formula(colnames(design.mat)[1:100] ~ ivs), data = design.mat)
model.formula <- as.formula(colnames(design.mat)[1:100] ~ ivs)
model.formula
mmr.model <- lm(colnames(design.mat)[1:100] ~ ., data = design.mat)
mmr.model <- lm(colnames(design.mat)[1] ~ ., data = design.mat)
colnames(design.mat)
lm(S.ETV1 ~ E.ECM1 + E.MET, data = design.mat)
mmr.model <- lm(design.mat[, 1:100] ~ ., data = design.mat)
mmr.model <- lm(design.mat[, 1:100] ~ E.ECM1 + E.MET, data = design.mat)
design.mat <- rbind( stroma.MRmat , epi.MRmat )
design.mat <- t(design.mat)
mmr.model <- lm(design.mat[, 1:100] ~ E.ECM1 + E.MET, data = design.mat)
mmr.model <- lm(design.mat[, 1:100] ~ design.mat[, 101:ncol(design.mat)])
mmr.model
saveRDS(mmr.model, 'C://Users/lvlah/linux/ac_lab/tumor_geom/lcm_model_fit.rds')
library(pca3d)
library(cluster)
library(viper)
library(ggplot2)
library(pheatmap)
library(RColorBrewer)
source('C://Users/lvlah/linux/ac_lab/code/algs/multiwayKMeans.R')
source('C://Users/lvlah/linux/ac_lab/single-cell-pipeline/lvScripts/cluster-functions.R')
r1.pAct <- readRDS('C://Users/lvlah/linux/ac_lab/data/filtered_feature_bc_matrix/car-lung_r1-pAct.rds')
r1.vipSim <- readRDS('C://Users/lvlah/linux/ac_lab/data/filtered_feature_bc_matrix/car-lung_r1-vipSim.rds')
#r1.vipSim <- viperSimilarity(r1.pAct)
r1.PCA <- prcomp(t(r1.pAct))
#pca3d(r1.PCA)
r1.clust <- readRDS('C://Users/lvlah/linux/ac_lab/data/filtered_feature_bc_matrix/car-lung_r1-clusts.rds')
#r1.clustSil <- SilScoreEval(r1.clust, r1.vipSim)
pca3d(r1.PCA, col = r1.clust$k2$clustering)
col.vect <- r1.clust$k2$clustering
mid.cells <- colnames(phiVals)[intersect(which(phiVals[1,] < 0.85), which(phiVals[1,] > 0.15))]
col.vect[mid.cells] <- 0
col.vect[which(col.vect == 0)] <- 'purple'
col.vect[which(col.vect == 1)] <- 'blue'
col.vect[which(col.vect == 2)] <- 'red'
pca3d(r1.PCA, col = col.vect)
c1.center <- rowMeans(r1.pAct[, which(r1.clust$k3$clustering == 1)])
c2.center <- rowMeans(r1.pAct[, which(r1.clust$k3$clustering == 3)])
k2.centers <- cbind(c1.center, c2.center)
r1.mwk2 <- Cluster(r1.pAct, k2.centers)
phiVals <- r1.mwk2[[1]]
r1.pAct <- readRDS('C://Users/lvlah/linux/ac_lab/data/cardoso_lung/car-lung_r1-pAct.rds')
r1.vipSim <- readRDS('C://Users/lvlah/linux/ac_lab/data/cardoso_lung/car-lung_r1-vipSim.rds')
#r1.vipSim <- viperSimilarity(r1.pAct)
r1.PCA <- prcomp(t(r1.pAct))
#pca3d(r1.PCA)
r1.clust <- readRDS('C://Users/lvlah/linux/ac_lab/data/cardoso_lung/car-lung_r1-clusts.rds')
#r1.clustSil <- SilScoreEval(r1.clust, r1.vipSim)
pca3d(r1.PCA, col = r1.clust$k2$clustering)
col.vect <- r1.clust$k2$clustering
mid.cells <- colnames(phiVals)[intersect(which(phiVals[1,] < 0.85), which(phiVals[1,] > 0.15))]
col.vect[mid.cells] <- 0
col.vect[which(col.vect == 0)] <- 'purple'
col.vect[which(col.vect == 1)] <- 'blue'
col.vect[which(col.vect == 2)] <- 'red'
pca3d(r1.PCA, col = col.vect)
c1.center <- rowMeans(r1.pAct[, which(r1.clust$k3$clustering == 1)])
c2.center <- rowMeans(r1.pAct[, which(r1.clust$k3$clustering == 3)])
k2.centers <- cbind(c1.center, c2.center)
r1.mwk2 <- Cluster(r1.pAct, k2.centers)
phiVals <- r1.mwk2[[1]]
phiVals
plot.dat <- data.frame('PC1' = r1.PCA$x[,1], 'PC2' = r1.PCA$x[,2])
plot.dat[['k2']] <- as.factor(r1.clust$k2$clustering)
plot.dat[['k3']] <- as.factor(r1.clust$k3$clustering)
ggplot(plot.dat, aes(x=PC1, y=PC2, color=k2)) + geom_point() +
ggtitle('R1 pAct PCA')
ggplot(plot.dat, aes(x=PC1, y=PC2, color=k3)) + geom_point() +
ggtitle('R1 pAct PCA')
plot.dat[['phi']] <- phiVals[1,]
plot.dat[['Sox2']] <- r1.pAct['Sox2',]
plot.dat[['Sox9']] <- r1.pAct['Sox9',]
ggplot(plot.dat, aes(x=PC1, y=PC2, color=phi)) + geom_point() +
ggtitle('R1 pAct PCA') + scale_colour_gradient(low = 'blue', high = 'red')
ggplot(plot.dat, aes(x=PC1, y=PC2, color=Sox2)) + geom_point() +
ggtitle('R1 pAct PCA') + scale_colour_gradient(low = 'blue', high = 'red')
ggplot(plot.dat, aes(x=PC1, y=PC2, color=Sox9)) + geom_point() +
ggtitle('R1 pAct PCA') + scale_colour_gradient(low = 'blue', high = 'red')
markers <- c('Cldn10', 'Cdkn1c', 'Sox2', 'Bmp4', 'Sox9',
'Foxp2', 'Etv5', 'Irx1', 'S100a6', 'Ctnnd2',
'Epha4')
annot.df <- data.frame('clust' = as.factor(r1.clust$k2$clustering[names(sort(phiVals[1,]))]),
'phi' = sort(phiVals[1,]))
pheatmap(r1.pAct[markers,names(sort(phiVals[1,]))], scale = 'row', annotation_col = annot.df,
color = colorRampPalette(rev(brewer.pal(10, 'RdBu')))(100),
cluster_rows = TRUE, cluster_cols = FALSE, show_colnames = FALSE, show_rownames = TRUE,
main = 'Multiway K-Means Analysis')
?apply
?cor
# mr correlation
pAct.phiCorr <- apply(r1.pAct, 1, function(x) { cor(x, y = phiVals, method = 'spearman') }
# mr correlation
pAct.phiCorr <- apply(r1.pAct, 1, function(x) { cor(x, y = phiVals, method = 'spearman') })
# mr correlation
pAct.phiCorr <- apply(r1.pAct, 1, function(x) { cor(x, y = phiVals, method = 'spearman') })
dim(r1.pAct)
length(phiVals)
# mr correlation
pAct.phiCorr <- apply(r1.pAct, 1, function(x) { cor(x, y = phiVals[1,colnames(r1.pAct)], method = 'spearman') })
pAct.phiCorr
hist(pAct.phiCorr)
saveRDS(pAct.phiCorr, file = 'C://Users/lvlah/linux/ac_lab/data/cardoso_lung/car-lung_r1-phiCorr.rds')
?sort
pAct.phiCorr <- pAct.phiCorr[ names(sort(abs(pAct.phiCorr, decreasing = TRUE))) ]
pAct.phiCorr <- pAct.phiCorr[ names(sort(abs(pAct.phiCorr), decreasing = TRUE)) ]
head(pAct.phiCorr)
pAct.phiCorr[1:50]
annot.df <- data.frame('phi' = sort(phiVals[1,]))
pheatmap(r1.pAct[ names(pAct.phiCorr)[1:50] , names(sort(phiVals[1,])) ], scale = 'row', annotation_col = annot.df,
color = colorRampPalette(rev(brewer.pal(10, 'RdBu')))(100),
cluster_rows = TRUE, cluster_cols = FALSE, show_colnames = FALSE, show_rownames = TRUE,
main = 'Multiway K-Means Analysis')
?pheatmap
pheatmap(r1.pAct[ names(pAct.phiCorr)[1:75] , names(sort(phiVals[1,])) ], scale = 'row', annotation_col = annot.df,
color = colorRampPalette(rev(brewer.pal(10, 'RdBu')))(100), fontsize = 4,
cluster_rows = TRUE, cluster_cols = FALSE, show_colnames = FALSE, show_rownames = TRUE,
main = 'Multiway K-Means Analysis')
row.df <- data.frame('correlation' = pAct.phiCorr[1:50])
pheatmap(r1.pAct[ names(pAct.phiCorr)[1:75] , names(sort(phiVals[1,])) ], scale = 'row',
annotation_col = annot.df, annotation_row = row.df,
color = colorRampPalette(rev(brewer.pal(10, 'RdBu')))(100), fontsize_row = 4,
cluster_rows = TRUE, cluster_cols = FALSE, show_colnames = FALSE, show_rownames = TRUE,
main = 'Multiway K-Means Analysis')
row.df <- data.frame('correlation' = abs(pAct.phiCorr[1:50]))
pheatmap(r1.pAct[ names(pAct.phiCorr)[1:75] , names(sort(phiVals[1,])) ], scale = 'row',
annotation_col = annot.df, annotation_row = row.df,
color = colorRampPalette(rev(brewer.pal(10, 'RdBu')))(100), fontsize_row = 4,
cluster_rows = TRUE, cluster_cols = FALSE, show_colnames = FALSE, show_rownames = TRUE,
main = 'Multiway K-Means Analysis')
annot.df <- data.frame('phi' = sort(phiVals[1,]))
row.df <- data.frame('corr' = abs(pAct.phiCorr[1:50]))
pheatmap(r1.pAct[ names(pAct.phiCorr)[1:75] , names(sort(phiVals[1,])) ], scale = 'row',
annotation_col = annot.df, annotation_row = row.df,
color = colorRampPalette(rev(brewer.pal(10, 'RdBu')))(100), fontsize_row = 4,
cluster_rows = FALSE, cluster_cols = FALSE, show_colnames = FALSE, show_rownames = TRUE,
main = 'Multiway K-Means Analysis')
annot.df <- data.frame('clust' = as.factor(r1.clust$k2$clustering[names(sort(phiVals[1,]))]),
'phi' = sort(phiVals[1,]))
pheatmap(r1.pAct[markers,names(sort(phiVals[1,]))], scale = 'row', annotation_col = annot.df,
color = colorRampPalette(rev(brewer.pal(10, 'RdBu')))(100),
cluster_rows = TRUE, cluster_cols = FALSE, show_colnames = FALSE, show_rownames = TRUE,
main = 'Multiway K-Means Analysis')
annot.df <- data.frame('clust' = as.factor(r1.clust$k2$clustering[names(sort(phiVals[1,]))]),
'phi' = sort(phiVals[1,]))
pheatmap(r1.pAct[markers,names(sort(phiVals[1,]))], scale = 'row', annotation_col = annot.df,
color = colorRampPalette(rev(brewer.pal(10, 'RdBu')))(100),
cluster_rows = TRUE, cluster_cols = FALSE, show_colnames = FALSE, show_rownames = TRUE,
main = 'Multiway K-Means Analysis')
stroma.net <- get(load('C://Users/lvlah/linux/ac_lab/data/lcm_pda/regul_stroma.rda'))
stroma.net.pruned <- pruneRegulon(stroma.net, 50, adaptive = FALSE, eliminate = TRUE)
epi.net <- get(load('C://Users/lvlah/linux/ac_lab/data/lcm_pda/regul_epith.rda'))
epi.net.pruned <- pruneRegulon(epi.net, 50, adaptive = FALSE, eliminate = TRUE)
hugo.names <- readRDS("C://Users/lvlah/linux/ac_lab/Hugo.Names.rds")
############################
stroma.mrs <- readRDS('C://Users/lvlah/linux/ac_lab/tumor_geom/lcm_stroma_msViper.rds')
epi.mrs <- readRDS('C://Users/lvlah/linux/ac_lab/tumor_geom/lcm_epi_msViper.rds')
stroma.vip <- readRDS('C://Users/lvlah/linux/ac_lab/tumor_geom/lcm_stroma_viper.rds')
epi.vip <- readRDS('C://Users/lvlah/linux/ac_lab/tumor_geom/lcm_epi_viper.rds')
metadata <- read.table('C://Users/lvlah/linux/ac_lab/data/lcm_pda/PDAC-Interactome-Samples_newOk.txt',
header = TRUE, sep = '\t')
############################
### generate correlation model(s) between stroma and epi compartments in lcm ###
## sync up IDs
stroma.patients <- metadata$PatientID[ match(colnames(stroma.vip), metadata$SampleID) ]
epi.patients <- metadata$PatientID[ match(colnames(epi.vip), metadata$SampleID) ]
shared.patients <- intersect(stroma.patients, epi.patients)
stroma.meta <- metadata[ which(metadata$Compartment == 'Stroma') ,]
matched.stromaID <- stroma.meta$SampleID[ match(shared.patients, stroma.meta$PatientID) ]
epi.meta <- metadata[ which(metadata$Compartment == 'Epithelium') ,]
matched.epiID <- epi.meta$SampleID[ match(shared.patients, epi.meta$PatientID) ]
length(matched.stromaID)
length(matched.epiID)
stroma.vip <- stroma.vip[, as.character(matched.stromaID) ]
epi.vip <- epi.vip[, as.character(matched.epiID) ]
## change to hugo gene names
rownames(stroma.vip) <- hugo.names[ rownames(stroma.vip) ]
rownames(epi.vip) <- hugo.names[ rownames(epi.vip) ]
## create the design matrix for the MMR model
stroma.MRmat <- stroma.vip[ intersect(names(sort(stroma.mrs$es$nes, decreasing = TRUE))[1:100], rownames(stroma.vip)) ,]
rownames(stroma.MRmat) <- paste('S.', rownames(stroma.MRmat), sep = '')
epi.MRmat <- epi.vip[ intersect(names(sort(epi.mrs$es$nes, decreasing = TRUE))[1:100], rownames(epi.vip)) ,]
rownames(epi.MRmat) <- paste('E.', rownames(epi.MRmat), sep = '')
design.mat <- rbind( stroma.MRmat , epi.MRmat )
design.mat <- t(design.mat)
## fit MMR model
dvs <- paste(colnames(design.mat)[1:100], collapse = ' + ')
ivs <- paste(colnames(design.mat)[101:ncol(design.mat)], collapse = ' + ')
model.formula <- as.formula(colnames(design.mat)[1:100] ~ ivs)
mmr.model <- lm(design.mat[, 1:100] ~ design.mat[, 101:ncol(design.mat)])
saveRDS(mmr.model, 'C://Users/lvlah/linux/ac_lab/tumor_geom/lcm_model_fit.rds')
### find single-cell distances using the bulk linear model ###
sc.pda <- readRDS('C://Users/lvlah/linux/ac_lab/data/singleCell/all/pdac-allPatients-geneExp.rds')
sc.metaData <- read.csv('C://Users/lvlah/linux/ac_lab/data/singleCell/all/metadata.csv', header = TRUE, row.names = 1)
View(sc.metaData)
ht150.samps <- rownames(sc.metaData)[which(sc.metaData$ID == 'HT150')]
ht150.samps
table(scsc.metaData$ID)
table(sc.metaData$ID)
ht150.samps <- rownames(sc.metaData)[which(sc.metaData$ID == 'HT143')]
ht143.pda <- sc.pda[, ht143.samps]
ht143.samps <- rownames(sc.metaData)[which(sc.metaData$ID == 'HT143')]
ht143.pda <- sc.pda[, ht143.samps]
dim(ht143.samps)
dim(ht143.pda
)
patient <- 'HT103'
pat.samps <- rownames(sc.metaData)[which(sc.metaData$ID == patient)]
pat.pda <- sc.pda[, pat.samps]
rm(ht143.pda)
dim(pat.pda)
## split the matrix into epithelial and stromal compartments
pat.eCells <- get(load('C://Users/lvlah/linux/ac_lab/data/cancerCellNames/names_cancer_cells_PDA_103.rda'))
ppat.eCells
pat.eCells
### find single-cell distances using the bulk linear model ###
source('C://Users/lvlah/linux/ac_lab/single-cell-pipeline/functions/process-utils.R')
QCPlots(pat.pda)
pat.filt <- QCTransform(pat.pda)
pat.cpm <- CPMTransform(pat.filt)
pat.epi <- pat.cpm[, intersect(pat.eCells, colnames(pat.cpm)) ]
dim(pat.epi)
length(pat.eCells)
pat.stroma <- pat.cpm[, setdiff(colnames(pat.cpm), pat.eCells) ]
dim(pat.stroma)
pat.epiRank <- RankTransform(pat.epi)
pat.stromaRank <- RankTransform(pat.stroma)
pat.epiVip <- viper(pat.epiRank, regulon = epi.net.pruned, method = 'none')
pat.stromaVip <- viper(pat.stromaRank, regulon = stroma.net.pruned, method = 'none')
rownames(pat.epiRank)
rownames(stroma.vip)
epi.net.pruned
names(epi.net.pruned)
convert.dict <- readRDS('C://Users/lvlah/linux/ac_lab/data/gene-convert-dict.rds')
View(convert.dict)
length(which(rownames(sc.pda) %in% convert.dict$Entrez.Gene.ID))
rownames(sc.pda)
length(which(rownames(sc.pda) %in% convert.dict$Ensembl.Gene.ID))
length(which(rownames(pat.cpm) %in% convert.dict$Ensembl.Gene.ID))
dim(pat.cpm)
## convert gene names to entrez
pat.cpm <- pat.cpm[ which(rownames(pat.cpm) %in% convert.dict$Ensembl.Gene.ID) ,]
dim(pat.cpm)
match(rownames(pat.cpm), convert.dict$Ensembl.Gene.ID)
rownames(pat.cpm) <- convert.dict$Entrez.Gene.ID[ match(rownames(pat.cpm), convert.dict$Ensembl.Gene.ID) ]
rownames(pat.cpm)
pat.cpm <- pat.cpm[ which(rownames(pat.cpm) %in% convert.dict$Ensembl.Gene.ID) ,]
rownames(pat.cpm) <- convert.dict$Entrez.Gene.ID[ match(rownames(pat.cpm), convert.dict$Ensembl.Gene.ID) ]
## split the matrix into epithelial and stromal compartments
pat.eCells <- get(load('C://Users/lvlah/linux/ac_lab/data/cancerCellNames/names_cancer_cells_PDA_103.rda'))
pat.epi <- pat.cpm[, intersect(pat.eCells, colnames(pat.cpm)) ]
pat.stroma <- pat.cpm[, setdiff(colnames(pat.cpm), pat.eCells) ]
pat.epiRank <- RankTransform(pat.epi)
pat.stromaRank <- RankTransform(pat.stroma)
## viper inference using bulk networks
pat.epiVip <- viper(pat.epiRank, regulon = epi.net.pruned, method = 'none')
pat.stromaVip <- viper(pat.stromaRank, regulon = stroma.net.pruned, method = 'none')
pat.cpm <- CPMTransform(pat.filt)
## convert gene names to entrez
pat.cpm <- pat.cpm[ which(rownames(pat.cpm) %in% convert.dict$Ensembl.Gene.ID) ,]
rownames(pat.cpm) <- convert.dict$Entrez.Gene.ID[ match(rownames(pat.cpm), convert.dict$Ensembl.Gene.ID) ]
## split the matrix into epithelial and stromal compartments
pat.eCells <- get(load('C://Users/lvlah/linux/ac_lab/data/cancerCellNames/names_cancer_cells_PDA_103.rda'))
pat.epi <- pat.cpm[, intersect(pat.eCells, colnames(pat.cpm)) ]
pat.stroma <- pat.cpm[, setdiff(colnames(pat.cpm), pat.eCells) ]
pat.epiRank <- RankTransform(pat.epi)
pat.stromaRank <- RankTransform(pat.stroma)
## viper inference using bulk networks
pat.epiVip <- viper(pat.epiRank, regulon = epi.net.pruned, method = 'none')
pat.stromaVip <- viper(pat.stromaRank, regulon = stroma.net.pruned, method = 'none')
## subset scVip matrices to MRs from LCM
pat.epiMR <- pat.epiVip[ rownames(stroma.MRmat) ,]
rownames(pat.stromaVip) <- hugo.names[ rownames(pat.stromaVip) ]
rownames(pat.epiVip) <- hugo.names[ rownames(pat.epiVip) ]
## subset scVip matrices to MRs from LCM
pat.epiMR <- pat.epiVip[ rownames(stroma.MRmat) ,]
dim(pat.epiVip)
intersect(rownames(stroma.MRmat), rownames(pat.epiVip))
rownames(stroma.MRmat)
rownames(pat.stromaVip) <- paste('S', rownames(pat.stromaVip), sep = '.')
rownames(pat.epiVip) <- paste('E', rownames(pat.epiVip), sep = '.')
rownames(pat.stromaVip)
intersect(rownames(stroma.MRmat), rownames(pat.epiVip))
intersect(rownames(stroma.MRmat), rownames(pat.stromaVip))
pat.stromaMR <- pat.stromaVip[ rownames(stroma.MRmat) ,]
pat.epiMR <- pat.epiVip[ rownames(epi.MRmat) ,]
## predict using the LCM MMR model
predict.stroma <- predict(mmr.model, t(pat.epiMR))
## predict using the LCM MMR model
predict.stroma <- predict(mmr.model, as.data.frame(t(pat.epiMR)) )
mmr.model
as.data.frame(t(pat.epiMR))
dim(as.data.frame(t(pat.epiMR)))
mmrmmr.model
mmr.model
dim(mmr.model$coefficients)
?predict
## predict using the LCM MMR model
predict.stroma <- predict(mmr.model, newdata = as.data.frame(t(pat.epiMR)) )
## predict using the LCM MMR model
predict.stroma <- predict.lm(mmr.model, newdata = as.data.frame(t(pat.epiMR)) )
?fitted
fitted(mmr.model)
View(mmr.model$coefficients)
cbind( as.matrix(rep(1, ncol(pat.epiMR))) , t(pat.epiMR) )
View(cbind( as.matrix(rep(1, ncol(pat.epiMR))) , t(pat.epiMR) ))
## predict using the LCM MMR model
predict.stroma <- cbind( as.matrix(rep(1, ncol(pat.epiMR))) , t(pat.epiMR) ) %*% as.matrix( mmr.model$coefficients )
dim(predict.stroma)
rownames(predict.stroma) <- colnames( pat.epiMR )
colnames(predict.stroma) <- rownames( mmr.model$coefficients )
View(predict.stroma)
colnames(predict.stroma) <- colnames( mmr.model$coefficients )
View(predict.stroma)
## infer pairwise distances
infer.distMat <- matrix(0L, nrow = ncol(pat.cpm), ncol = ncol(pat.cpm))
rownames(infer.distMat) <- c(colnames(pat.epiMR), colnames(pat.stromaMR)); colnames(infer.distMat) <- c(colnames(pat.epiMR), colnames(pat.stromaMR))
View(infer.distMat)
dim(pat.stromaMR)
i <- 1
j <- 1
pair.dist <- dist( rbind( predict.stroma[i,] , pat.stromaMR[,j] ) )
papair.dist
pair.dist
pair.dist1]
pair.dist[1]
infer.distMat <- matrix(0L, nrow = ncol(pat.cpm), ncol = ncol(pat.cpm))
rownames(infer.distMat) <- c(colnames(pat.epiMR), colnames(pat.stromaMR)); colnames(infer.distMat) <- c(colnames(pat.epiMR), colnames(pat.stromaMR))
for (i in 1:nrow(predict.stroma) ) {
e.Name <- rownames(predict.stroma)[i]
for (j in 1:ncol(pat.stromaMR) ) {
s.Name <- colnames(pat.stromaMR)[j]
pair.dist <- dist( rbind( predict.stroma[i,] , pat.stromaMR[,j] ) )[1]
infer.distMat[e.Name, s.Name] <- pair.dist
infer.distMat[s.Name, e.Name] <- pair.dist
}
}
dim(infer.distMat)
diag(infer.distMat)
sum(diag(infer.distMat))
dim(predict.stroma)
infer.distMat[60,59]
infer.distMat[60,60]
infer.distMat[60,61]
infer.distMat[60,60]
infer.distMat[61,60]
infer.distMat[59,60]
infer.distMat[61,62]
install.packages('ape')
library(ape)
complete.distMat <- as.dist( additive(infer.distMat) )
View(complete.distMat)
?as.dist
partial.distMat <- as.dist(infer.distMat)
partial.distMat[partial.distMat == 0] <- NA
partial.distMat
head(partial.distMat)
complete.distMat <- as.dist( additive(partial.distMat) )
## MDS to find 3D coordinates
library(MASS)
library(ggplot2)
mds.fit <- isoMDS(complete.distMat, k = 3)
View(as.data.frame(complete.distMat))
View(as.matrix(complete.distMat))
complete.distMat <- as.dist( ultrametric(partial.distMat) )
mds.fit <- isoMDS(complete.distMat, k = 3)
install.packages("scatterplot3d")
library("scatterplot3d")
mds.fit$points
scatterplot3d(mds.fit$points)
dev.off()
scatterplot3d(mds.fit$points)
compartment <- c(rep('epithelial', 60), rep('stromal', nrow(infer.distMat) - 60))
compartment
colors <- c('red', 'blue')[as.numeric(compartment)]
scatterplot3d(mds.fit$points, colors = colors, box = FALSE)
colors <- c(rep('red', 60), rep('blue', nrow(infer.distMat) - 60))
scatterplot3d(mds.fit$points, colors = colors, box = FALSE)
scatterplot3d(mds.fit$points, color = colors, box = FALSE)
plot.mat <- mds.fit$points
rownames(plot.mat) <- rownames(infer.distMat); colnames(plot.mat) <- c('MDS1', 'MDS2', 'MDS3')
compartment <- c(rep('epithelial', 60), rep('stromal', nrow(infer.distMat) - 60))
colors <- c(rep('red', 60), rep('blue', nrow(infer.distMat) - 60))
scatterplot3d(plot.mat, color = colors, box = FALSE)
scatterplot3d(plot.mat, color = colors, box = FALSE, pch = 16)
scatterplot3d(plot.mat * c(-1, -1, 1), color = colors, box = FALSE, pch = 16)
setwd('C://Users/lvlah/linux/ac_lab/single-cell-pipeline/')
library(rmarkdown)
render('PISCES_walkthrough.Rmd')
r2.pAct <- Ensemble2GeneName(r2.pAct)
render('PISCES_walkthrough.Rmd')
render('PISCES_walkthrough.Rmd')
render('PISCES_walkthrough.Rmd')
render('PISCES_walkthrough.Rmd')
